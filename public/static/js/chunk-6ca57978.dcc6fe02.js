(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-6ca57978"],{"4b0e":function(e,t,n){"use strict";n("7f45")},"7f45":function(e,t,n){},"83e8":function(e,t,n){"use strict";n.r(t);var o=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("div",{attrs:{id:"left-side"}},[e._m(0),n("div",{staticClass:"message"},[n("h6",[e._v("笔记")]),n("ul",[n("li",{staticClass:"notes-icon"},[e._v("分享笔记")]),n("button",{on:{click:e.savePaint}},[e._v("保存画板")])])]),n("div",{staticClass:"user-list"},[n("h6",[e._v("用户"),n("span",{staticClass:"user-num"},[e._v("("+e._s(e.participantNumber)+")")])]),n("ul",e._l(e.participants,(function(t){return n("li",[n("i",{staticClass:"user-icon"},[void 0==t.account?n("span",[e._v("\n                            D\n                        ")]):n("span",[e._v("\n                            "+e._s(t.account.slice(0,1))+"\n                        ")])]),void 0==t.account?n("span",[e._v("\n                        Default\n                    ")]):n("span",[e._v("\n                        "+e._s(t.account)+"\n                    ")]),t.account==e.account?n("span",[e._v("（您）")]):e._e()])})),0)]),n("div",{staticClass:"clear"})]),n("div",{attrs:{id:"message"}},[e._m(1),n("div",{staticClass:"msg-list"},[n("ul",e._l(e.messageList,(function(t){return n("li",[n("p",{staticClass:"speaker"},[e._v("\n                        "+e._s(t.user)+"\n                        ")]),n("p",[e._v("\n                        "+e._s(t.content)+"\n                    ")])])})),0)]),n("div",{staticClass:"msg-ipt"},[n("input",{directives:[{name:"model",rawName:"v-model",value:e.sendText,expression:"sendText"}],attrs:{type:"text"},domProps:{value:e.sendText},on:{input:function(t){t.target.composing||(e.sendText=t.target.value)}}}),n("i",{staticClass:"send-icon",on:{click:e.sendMsg}})])]),n("div",{attrs:{id:"wrapper"}},[n("div",{attrs:{id:"paint-board"}},[n("div",{attrs:{id:"paint-board-container"}},[n("canvas",{ref:"canvas",staticClass:"my-canvas",attrs:{id:"my-canvas0",width:"1040",height:"675"}}),e._m(2),n("div",{attrs:{id:"video-list"}},[n("div",{ref:"video-box",staticClass:"video-box",attrs:{id:"videoBox"}},[n("div",[n("video",{ref:"video-mine",staticClass:"video-mine",attrs:{autoplay:"",controls:"",id:"video-test"}}),n("span",{staticClass:"video-user"},[e._v(e._s(e.account))])])])])]),e._m(3),n("div",{attrs:{id:"paint-tool"}},[n("ul",e._l(e.handleList,(function(t){return n("li",{key:t.type,attrs:{id:"lineWidth"===t.type?"linewidth":""}},["color"===t.type?n("el-color-picker",{attrs:{"show-alpha":"",disabled:e.allowHangup},on:{change:e.colorChange},model:{value:e.color,callback:function(t){e.color=t},expression:"color"}}):e._e(),["color","lineWidth","polygon"].includes(t.type)?e._e():n("button",{class:{active:e.currHandle===t.type},attrs:{disabled:"cancel"===t.type?e.allowHangup||e.allowCancel:"go"===t.type?e.allowHangup||e.allowGo:e.allowHangup},on:{click:function(n){return e.handleClick(t)}}},[e._v("\n                            "+e._s(t.name)+"\n                        ")]),"polygon"===t.type?n("el-popover",{attrs:{placement:"top",width:"400",trigger:"click"}},[n("el-input-number",{attrs:{"controls-position":"right",min:3,max:10},on:{change:e.sidesChange},model:{value:e.sides,callback:function(t){e.sides=t},expression:"sides"}}),n("button",{class:{active:e.currHandle===t.type},attrs:{slot:"reference",disabled:e.allowHangup},on:{click:function(n){return e.handleClick(t)}},slot:"reference"},[e._v(e._s(t.name)+"\n                            ")])],1):e._e(),"lineWidth"===t.type?n("el-popover",{attrs:{placement:"top",width:"400",trigger:"click"}},[n("el-slider",{attrs:{max:20},on:{change:e.lineWidthChange},model:{value:e.lineWidth,callback:function(t){e.lineWidth=t},expression:"lineWidth"}}),n("button",{attrs:{slot:"reference",disabled:e.allowHangup},slot:"reference"},[e._v(e._s(t.name)+" "),n("i",[e._v(e._s(e.lineWidth+"px"))])])],1):e._e()],1)})),0)])])])])},a=[function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"message"},[n("h6",[e._v("消息")]),n("ul",[n("li",{attrs:{id:"common-chat"}},[n("i",{staticClass:"message-icon"}),e._v("公共聊天\n                ")])])])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"msg-title"}},[n("span",[n("i",{staticClass:"left-arrow-icon"}),e._v("\n        公共聊天\n    ")])])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"tool"}},[n("div",{attrs:{id:"switch"}},[n("select",[n("option",[e._v("幻灯片1")]),n("option",[e._v("幻灯片2")]),n("option",[e._v("幻灯片3")]),n("option",[e._v("幻灯片4")]),n("option",[e._v("幻灯片5")])])])])},function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{attrs:{id:"side-tool"}},[n("ul",[n("li",[n("i",{staticClass:"more-tool-icon"})]),n("li",{staticClass:"last"},[n("i",{staticClass:"delete-icon"})])])])}],i=(n("c904"),n("6d57"),n("2b45"),n("232a")),s=n("b382"),c=n("b573"),r=(n("ed63"),n("8cf2"),n("6a61"),n("327b")),l=n("29b2"),u=n("ebd6"),d={name:"index",data:function(){return{currentCanvasIndex:0,canvas:[],context:[],peerA:null,peerB:null,offerOption2:{offerToReceiveAudio:1,offerToReceiveVideo:1},allowCall:!0,allowHangup:!0,handleList:[{name:"圆",type:"arc"},{name:"线条",type:"line"},{name:"矩形",type:"rect"},{name:"多边形",type:"polygon"},{name:"橡皮擦",type:"eraser"},{name:"撤回",type:"cancel"},{name:"前进",type:"go"},{name:"清屏",type:"clear"},{name:"线宽",type:"lineWidth"},{name:"颜色",type:"color"}],color:"rgba(19, 206, 102, 1)",currHandle:"line",lineWidth:5,palette:[],allowCancel:!0,allowGo:!0,sides:3,boardLocalStream:null,messageList:[],sendText:"",isToPeer:!1,receiverChannel:{},roomid:0,peer:null,peerList:{},paintPeerList:{},channelList:{},candidate:null,localStream:null,participants:[],participantNumber:0,account:"Default",queuedSendMsg:[],hostFlag:0}},watch:{userList:{handler:function(){},deep:!0}},beforeDestroy:function(){for(var e in this.peerList)this.peerList[e].close(),this.peerList[e]=null,this.paintPeerList[e].close(),this.paintPeerList[e]=null},methods:{initPeer:function(){var e=this,t=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;this.peer=new t,this.peer.onicecandidate=function(t){t.candidate&&l["a"].emit("__ice_candidate",{candidate:t.candidate,roomid:e.$route.query.roomid,account:t.account,type:"video"})}},createP2P:function(){var e=Object(r["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.loading=!0,e.next=3,this.initPeer();case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),saveImageInfo:function(){var e=document.getElementById("my-canvas"),t=e.toDataURL("image/png"),n=window.open("about:blank","image from canvas");n.document.write("<img src='"+t+"' alt='from canvas'/>")},getUserMedia:function(){var e=this,t=this.$refs["video-mine"],n=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return new Promise((function(o,a){n.call(navigator,{audio:!1,video:!0},(function(n){t.srcObject=n,e.localStream=n,o()}),(function(e){a(e)}))}))},getVideoUserName:function(e){return"todo"},getPeerConnection:function(e){var t=this,n={iceServers:[{url:"stun:stun.l.google.com:19302"}]},o=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,a=new o(n);a.addStream(this.localStream),a.onaddstream=function(t){var n=document.querySelector("#"+e.account);if(n)n.srcObject=t.stream;else{var o=document.getElementById("videoBox"),a=document.createElement("li"),i=document.createElement("video");i.setAttribute("class","video-mine"),i.controls=!0,i.autoplay="autoplay",i.srcObject=t.stream,i.id=e.account,a.append(i);var s=document.createElement("span");s.setAttribute("class","video-user"),s.innerText="todo",a.append(s),console.log("============= getPeerConnection start"),console.log(o),console.log("============= getPeerConnection end"),o.append(a)}},a.onicecandidate=function(n){n.candidate&&l["a"].emit("__ice_candidate",{candidate:n.candidate,roomid:t.$route.query.roomid,account:e.account,type:"video",user:t.account})},this.peerList[e.account]=a},getPaintPeerConnection:function(e){var t=this.initPeer2(e);console.log("paintPeer start"),console.log(t),console.log(e.account),console.log("paintPeer end"),this.paintPeerList[e.account]=t,1==this.hostFlag?(this.createDataChannel(e.account),this.createOfferPaint(e.account,this.paintPeerList[e.account],"paint")):this.onDataChannel(e.account)},createOfferPaint:function(e,t,n){var o=this;t.createOffer().then((function(a){t.setLocalDescription(a,(function(){l["a"].emit("offer",{sdp:t.localDescription,roomid:o.$route.query.roomid,account:e,type:n})}))}))},createOffer:function(e,t,n){var o=this;t.createOffer({offerToReceiveAudio:0,offerToReceiveVideo:1}).then((function(a){t.setLocalDescription(a,(function(){l["a"].emit("offer",{sdp:t.localDescription,roomid:o.$route.query.roomid,account:e,type:n})}))}))},socketInit:function(){var e=this;l["a"].on("offer",(function(t){var n=t.type,o={};o="paint"==n?e.paintPeerList:e.peerList,o[t.account]&&o[t.account].setRemoteDescription(t.sdp,(function(){o[t.account].createAnswer().then((function(a){o[t.account].setLocalDescription(a,(function(){l["a"].emit("answer",{sdp:o[t.account].localDescription,roomid:e.$route.query.roomid,account:t.account,type:n})}))}))}),(function(){}))})),l["a"].on("answer",(function(t){console.log("take_answer",t.sdp);var n=t.type,o={};o="paint"==n?e.paintPeerList:e.peerList,o[t.account]&&o[t.account].setRemoteDescription(t.sdp,(function(){}),(function(){})).catch((function(e){console.log(e)}))})),l["a"].on("__ice_candidate",(function(t){var n={},o=t.type;n="paint"==o?e.paintPeerList:e.peerList,t.candidate&&n[t.account]&&n[t.account].addIceCandidate(t.candidate).catch((function(e){console.log("__ice_candidate_err",e)}))})),l["a"].on("disconnected",(function(e){console.log("disconnected======",e);var t=document.querySelector("#"+e);t&&t.remove()})),l["a"].on("test",(function(t,n,o,a,i){console.log("manychat start");var s={user:n,time:o,content:a,type:i};console.log(s),e.messageList.push(s),console.log(e.messageList),console.log("manychat end")})),l["a"].on("why",(function(e){console.log("wy start"),console.log(e),console.log("manychat end")}))},initPalette:function(){for(var e=0;e<this.canvas.length;e++){console.log("this.palette.push1");for(var t=this.canvas[e],n=this.context[e],o=n.getImageData(0,0,t.width,t.height),a=(document.getElementById("canvas-txt"),new u["a"](t,{paint:n,imgDataInit:o,drawColor:this.color,drawType:this.currHandle,lineWidth:this.lineWidth,allowCallback:this.allowCallback,moveCallback:this.moveCallback})),i=!1,s=0;s<this.palette.length;s++){var c=this.palette[s];t.id==c.canvas.id&&(console.log("this.palette.push2"),i=!0)}0==i&&(console.log("this.palette.push"+a),this.palette.push(a))}},moveCallback:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];console.log("moveCallback",t),this.send(t)},allowCallback:function(e,t){console.log("cancle="+e),this.allowCancel=!e,this.allowGo=!t},send:function(e){for(var t in console.log("send =========="+this.channelList),this.channelList){var n=this.channelList[t];if(console.log("channelList.length: = "+n),console.log("channelList.length: = "+n.readyState),console.log("channelList.length: = "+n.readyState),console.log("channelList.length: = "+t),"text"===e[0]){var o={user:this.account,time:this.formatTime(new Date),content:this.sendText+"-------cg",type:"text"};n.send(JSON.stringify(o)),this.messageList.push(o),this.sendText=""}else"open"==n.readyState&&(console.log("send",e),n.send(JSON.stringify(e)))}},sidesChange:function(){this.palette[this.currentCanvasIndex].changeWay({sides:this.sides})},colorChange:function(){console.log("========================colorChange start"),console.log(this.color),console.log("========================colorChange end"),this.palette[this.currentCanvasIndex].changeWay({color:this.color})},lineWidthChange:function(){this.palette[this.currentCanvasIndex].changeWay({lineWidth:this.lineWidth})},handleClick:function(e){console.log("========================this.palette start"),console.log(this.palette),console.log(this.currentCanvasIndex);var t=0;for(var n in this.channelList)t++,console.log("channelList.length:"+n);console.log("channelList.length:"+t),console.log("========================this.palette end");var o=this.palette[this.currentCanvasIndex];["cancel","go","clear"].includes(e.type)?o[e.type]():(o.changeWay({type:e.type}),["color","lineWidth"].includes(e.type)||(this.currHandle=e.type))},start:function(){this.state="2",this.newRecognition.start()},stop:function(){this.state="1",this.newRecognition.stop()},call2:function(){var e=Object(r["a"])(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.peerB.createOffer(this.offerOption2);case 3:return t=e.sent,e.next=6,this.onCreateOffer(t);case 6:e.next=11;break;case 8:e.prev=8,e.t0=e["catch"](0),console.log("createOffer: ",e.t0);case 11:this.allowCall=!0,this.allowHangup=!1;case 13:case"end":return e.stop()}}),e,this,[[0,8]])})));function t(){return e.apply(this,arguments)}return t}(),hangup2:function(){this.peerA.close(),this.peerB.close(),this.peerA=null,this.peerB=null,this.allowCall=!1,this.allowHangup=!0,this.palette.destroy(),this.palette=null},onCreateOffer:function(){var e=Object(r["a"])(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.peerB.setLocalDescription(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e["catch"](0),console.log("Offer-setLocalDescription: ",e.t0);case 8:return e.prev=8,e.next=11,this.peerA.setRemoteDescription(t);case 11:e.next=16;break;case 13:e.prev=13,e.t1=e["catch"](8),console.log("Offer-setRemoteDescription: ",e.t1);case 16:return e.prev=16,e.next=19,this.peerA.createAnswer();case 19:return n=e.sent,e.next=22,this.onCreateAnswer(n);case 22:e.next=27;break;case 24:e.prev=24,e.t2=e["catch"](16),console.log("createAnswer: ",e.t2);case 27:case"end":return e.stop()}}),e,this,[[0,5],[8,13],[16,24]])})));function t(t){return e.apply(this,arguments)}return t}(),onCreateAnswer:function(){var e=Object(r["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.peerA.setLocalDescription(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e["catch"](0),console.log("answer-setLocalDescription: ",e.t0);case 8:return e.prev=8,e.next=11,this.peerB.setRemoteDescription(t);case 11:e.next=16;break;case 13:e.prev=13,e.t1=e["catch"](8),console.log("answer-setRemoteDescription: ",e.t1);case 16:case"end":return e.stop()}}),e,this,[[0,5],[8,13]])})));function t(t){return e.apply(this,arguments)}return t}(),initPeer2:function(e){var t=this,n={iceServers:[{url:"stun:stun.l.google.com:19302"}]},o=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,a=new o(n);return a.onicecandidate=function(n){n.candidate&&l["a"].emit("__ice_candidate",{candidate:n.candidate,roomid:t.$route.query.roomid,account:e.account,type:"paint",user:e.user})},a},createMedia2:function(){var e=Object(r["a"])(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:this.createP2P();case 1:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}(),createDataChannel:function(e){try{var t=this.paintPeerList[e].createDataChannel("messagechannel");this.channelList[e]=t,console.log("createDataChannel start"),console.log(this.paintPeerList[e]),console.log(t),console.log("createDataChannel end"),this.handleChannel(t)}catch(n){console.log("createDataChannel:",n)}},onDataChannel:function(e){var t=this;this.paintPeerList[e].ondatachannel=function(n){t.channelList[e]=n.channel,t.handleChannel(n.channel)}},isObjectValueEqual:function(e,t){var n=Object.getOwnPropertyNames(e),o=Object.getOwnPropertyNames(t);if(n.length!=o.length)return!1;for(var a=0;a<n.length;a++){var i=n[a],s=e[i],r=t[i];if("object"===Object(c["a"])(s)){if(!this.isObjectValueEqual(s,r))return!1}else if(s!==r)return!1}return!0},handleChannel:function(e){var t=this;e.binaryType="arraybuffer",e.onopen=function(e){console.log("channel onopen",e),t.isToPeer=!0,t.loading=!1},e.onclose=function(e){console.log("channel onclose",e)},e.onmessage=function(e){var n=t.palette[t.currentCanvasIndex];if(Array.isArray(JSON.parse(e.data))){var o=JSON.parse(e.data),a=Object(s["a"])(o),c=a[0],r=a.slice(1);console.log("onmessage",c,r),1==t.hostFlag&&(console.log("host 转发："+r),t.send(JSON.parse(e.data))),n[c].apply(n,Object(i["a"])(r))}else{var l=JSON.parse(e.data);t.messageList.push(l)}console.log("channel onmessage",e.data)},e.onerror=function(e){console.log("channel event.message:"+e.message)}},formatTime:function(e){var t=e.getHours(),n=e.getMinutes(),o=e.getSeconds();return[t,n,o].map(this.formatNumber).join(":")},formatNumber:function(e){return e=e.toString(),e[1]?e:"0"+e},sendMsg:function(){var e={roomid:this.roomid,account:this.account,time2:this.formatTime(new Date),mes2:this.sendText,type:"text"};console.log("发送----------start"),console.log(e),console.log("发送----------end"),l["a"].emit("manychat",e),this.sendText=""},savePaint:function(){var e=document.getElementById("my-canvas0"),t=e.toDataURL();alert(t);var n={roomid:this.roomid,paint:t,account:this.account};l["a"].emit("savepaint",n)},drawCircle:function(){var e=document.getElementById("myCanvas"),t=e.getContext("2d");t.beginPath(),t.arc(95,50,40,0,2*Math.PI),t.stroke()},createCanvas:function(e){for(var t=this,n=function(){var n="my-canvas"+o,i=document.getElementById(n);t.canvas.push(i);var s=i.getContext("2d");t.context.push(s),console.log("this.context start"),console.log(t.context),console.log("this.context end"),a=new Image,a.onload=function(){s.drawImage(this,0,0,i.width,i.height)},a.src=e},o=0;o<1;o++){var a;n()}}},mounted:function(){var e=this;this.$nextTick((function(){e.hostFlag=e.$route.query.hostFlag,0==e.roomid&&(e.roomid=e.$route.query.roomid),console.log("this.roomid:"+e.roomid),e.allowCall=!0,e.allowHangup=!1,e.getUserMedia().then((function(){e.account=e.$route.query.account,l["a"].emit("join",{roomid:e.roomid,account:e.account,is_host:e.hostFlag})})),e.socketInit(),e.boardLocalStream=e.$refs["canvas"].captureStream(),l["a"].on("joined",(function(t,n,o,a,i){e.messageList=a,console.log("主持人users start");for(var s=0;s<t.length;s++)console.log("user:"+t[s]);if(console.log("主持人users end"),e.participants=t,e.participantNumber=t.length,e.createCanvas(i),console.log("data.length:"+t.length),t.length>=1&&(t.forEach((function(n){var o={},a=[n.account,e.$route.query.account];o.account=a.sort().join("-"),o.user=e.account,e.initPalette(),e.peerList[o.account]||n.account===e.$route.query.account||1!=t.is_host&&e.getPaintPeerConnection(o)})),n===e.$route.query.account))for(var c in e.peerList)console.log("=======k start"),console.log(c),console.log("=======k end"),e.createOffer(c,e.peerList[c],"video")}))}))},created:function(){}},h=d,p=(n("4b0e"),n("2c07")),g=Object(p["a"])(h,o,a,!1,null,"2b535cd4",null);t["default"]=g.exports},b573:function(e,t,n){"use strict";function o(e){return o="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}n.d(t,"a",(function(){return o}))}}]);